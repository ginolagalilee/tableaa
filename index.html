<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calcul de Crédit et Tableau d'Amortissement</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>Calculateur de Crédit</h1>
    </header>

    <section class="input-section">
      <label for="montant">Montant de l'emprunt:</label>
      <input type="number" id="montant" placeholder="Montant en EUR ou USD" required min="0" step="0.01">

      <label for="duree">Durée du prêt:</label>
      <input type="number" id="duree" placeholder="Durée" required min="1">

      <label for="uniteDuree">Unité de durée:</label>
      <select id="uniteDuree">
        <option value="mois">Mois</option>
        <option value="annees">Années</option>
      </select>

      <label for="taux">Taux annuel du crédit (%):</label>
      <input type="number" id="taux" placeholder="Taux annuel en %" required min="0" step="0.01">

      <label for="devise">Devise:</label>
      <select id="devise">
        <option value="EUR">EUR</option>
        <option value="USD">USD</option>
        <option value="GBP">GBP</option>
      </select>

      <label for="debut">Début du crédit:</label>
      <input type="date" id="debut">

      <button onclick="calculerCredit()">Calculer</button>
    </section>

    <section class="resultats">
      <h2>Résultats</h2>
      <p id="mensualiteResult"></p>
      <p id="totalMensualites"></p>
      <p id="totalInterets"></p>
    </section>

    <section class="tableau">
      <table id="tableauAmortissement">
        <thead>
          <tr>
            <th>Mois / Échéance</th>
            <th>Mensualité</th>
            <th>Principal</th>
            <th>Intérêt</th>
            <th>Solde restant</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </section>

    <footer>
      <button onclick="exporterExcel()">Exporter en Excel</button>
      <button onclick="exporterWord()">Exporter en Word</button>
    </footer>
  </div>

  <script>
    function calculerCredit() {
      let montant = parseFloat(document.getElementById("montant").value);
      let duree = parseInt(document.getElementById("duree").value);
      let uniteDuree = document.getElementById("uniteDuree").value;
      let tauxAnnuel = parseFloat(document.getElementById("taux").value) / 100;
      let devise = document.getElementById("devise").value;
      let debut = document.getElementById("debut").value || new Date().toISOString().split('T')[0];

      // Validation
      if (isNaN(montant) || montant <= 0 || isNaN(duree) || duree <= 0 || isNaN(tauxAnnuel) || tauxAnnuel < 0) {
        alert("Veuillez remplir correctement tous les champs avec des valeurs valides.");
        return;
      }

      if (uniteDuree === "annees") {
        duree = duree * 12;
      }

      let tauxMensuel = tauxAnnuel / 12;

      let mensualite = (montant * tauxMensuel) / (1 - Math.pow(1 + tauxMensuel, -duree));
      let totalMensualites = mensualite * duree;
      let totalInterets = totalMensualites - montant;

      document.getElementById("mensualiteResult").innerHTML = "Mensualité du crédit : " + formatMonnaie(mensualite, devise);
      document.getElementById("totalMensualites").innerHTML = "Total des mensualités : " + formatMonnaie(totalMensualites, devise);
      document.getElementById("totalInterets").innerHTML = "Total des intérêts : " + formatMonnaie(totalInterets, devise);

      remplirTableauAmortissement(montant, tauxMensuel, duree, mensualite, devise, debut);
    }

    function formatMonnaie(montant, devise) {
      return montant.toLocaleString('fr-FR', { style: 'currency', currency: devise });
    }

    function remplirTableauAmortissement(montant, tauxMensuel, duree, mensualite, devise, debut) {
      let tableau = document.getElementById("tableauAmortissement").getElementsByTagName('tbody')[0];
      tableau.innerHTML = "";

      let soldeRestant = montant;
      let date = new Date(debut);

      for (let mois = 1; mois <= duree; mois++) {
        let interet = soldeRestant * tauxMensuel;
        let principal = mensualite - interet;
        soldeRestant -= principal;

        // Formater la date d'échéance
        let dateEcheance = `${("0" + (date.getMonth() + 1)).slice(-2)}/${date.getFullYear()}`;
        date.setMonth(date.getMonth() + 1);

        let row = tableau.insertRow();
        row.insertCell(0).textContent = dateEcheance;
        row.insertCell(1).textContent = formatMonnaie(mensualite, devise);
        row.insertCell(2).textContent = formatMonnaie(principal, devise);
        row.insertCell(3).textContent = formatMonnaie(interet, devise);
        row.insertCell(4).textContent = formatMonnaie(Math.max(soldeRestant, 0), devise); // éviter les négatifs
      }
    }

    function exporterExcel() {
      let table = document.getElementById("tableauAmortissement");
      let html = table.outerHTML;
      let blob = new Blob([html], { type: 'application/vnd.ms-excel' });
      let link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "tableau_amortissement.xls"; // .xls plus compatible
      link.click();
    }

    function exporterWord() {
      let table = document.getElementById("tableauAmortissement");
      let html = `
        <html xmlns:o='urn:schemas-microsoft-com:office:office' 
              xmlns:w='urn:schemas-microsoft-com:office:word' 
              xmlns='http://www.w3.org/TR/REC-html40'>
        <head><meta charset='utf-8'><title>Export Word</title></head>
        <body>${table.outerHTML}</body></html>`;

      let blob = new Blob([html], { type: 'application/msword' });
      let link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "tableau_amortissement.doc";
      link.click();
    }
  </script>
</body>
</html>
